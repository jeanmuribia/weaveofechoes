<form>
  <div class="sheet-container">
    <header class="sheet-header">
      <h1>{{actorName}}</h1>
    </header>

    <!-- Tabs -->
    <nav class="sheet-tabs tabs" data-group="primary-tabs">
      <a class="item" data-tab="profile">Profile</a>
      <a class="item" data-tab="relationships">Relationships</a>
      <a class="item" data-tab="biography">Biography</a>
      <a class="item" data-tab="private-notes">Private Notes</a>
    </nav>

    <!-- Tab contents -->
    <div class="tab-content">
      
<div class="tab active" data-tab="profile">
<!-- Identity Section -->
<section class="identity-section" style="width: 807px; margin: 0 auto;">
  <h2 class="section-header">Identity</h2>
  
  <div class="basic-info">
    <div class="info-field">
      <label class="info-label">Name:</label>
      <span id="actor-name" class="clickable">{{actorName}}</span>
      <input id="name-edit" type="text" class="hidden" />
    </div>

    <div class="info-field">
      <label class="info-label">Element:</label>
      <span id="element-view" class="clickable">
        {{capitalize system.element.value}}
        <i class="element-icon {{system.element.value}}"></i>
      </span>
      <select id="element-edit" class="hidden">
  <option value="none" {{#if (eq system.element.value "none")}}selected{{/if}}>None</option>
  <option value="fire" {{#if (eq system.element.value "fire")}}selected{{/if}}>Fire</option>
  <option value="water" {{#if (eq system.element.value "water")}}selected{{/if}}>Water</option>
  <option value="earth" {{#if (eq system.element.value "earth")}}selected{{/if}}>Earth</option>
  <option value="air" {{#if (eq system.element.value "air")}}selected{{/if}}>Air</option>
</select>
    </div>
  </div>
</section>

<div class="profile-resources-container">
  <div class="profile-container">
    <div class="profile-image">
      <img src="{{actor.img}}" alt="{{actor.name}}" />
    </div>
  </div>
 
 <!-- Resource Cards -->
<div class="resource stamina">
  <label class="resource-label">Stamina</label>
  <div class="resource-value">{{system.stamina.current}}</div>
  <div class="resource-controls">
    <button id="stamina-minus" class="resource-btn">-</button>
    <button id="stamina-plus" class="resource-btn">+</button>
  </div>
  <div class="resource-max-container" id="stamina-max-container">
    Max: <span id="stamina-max">{{system.stamina.max}}</span>
  </div>
  <input type="number" id="stamina-max-edit" class="hidden" min="1" max="6" value="{{system.stamina.max}}" />
</div>

<div class="resource focus">
  <label class="resource-label">Focus</label>
  <div class="resource-value">{{system.focusPoints.current}}</div>
  <div class="resource-controls">
    <button id="focus-minus" class="resource-btn">-</button>
    <button id="focus-plus" class="resource-btn">+</button>
  </div>
  <div class="focus-toggle-container">
    <label>
      <input type="checkbox" id="focus-toggle" {{checked system.focusPoints.isVisible}} /> Show
    </label>
  </div>
</div>

    <div class="resource synergy">
      <label class="resource-label">Synergy</label>
      <div class="resource-value {{#if isNotInGroup}}not-in-group{{/if}}">
        {{#if isNotInGroup}}
          Not in a group yet
        {{else}}
          {{currentSynergy}}
        {{/if}}
      </div>
      {{#unless isNotInGroup}}
        <div class="resource-controls">
          <div>Base: {{maxSynergy}}</div>
        </div>
      {{/unless}}
    </div>
  </div>


</section>
<div class="section-container">

<!-- Section principale des Tempers et Attributes -->
<div class="tempers-attributes-container">
  <!-- Wrapper pour Tempers et Maneuver -->
  <div class="tempers-maneuver-wrapper">
    <!-- Section Tempers -->
  <section class="tempers-section">
  <h2>Tempers</h2>
  <div class="tempers-grid">
    {{#each system.tempers as |temper key|}}
      <div 
        class="temper-card {{#if temper.injury}}disabled{{/if}}" 
        data-value="{{temper.currentValue}}" 
        data-field="{{key}}" 
        data-type="tempers"
      >
        <!-- Header de la carte -->
        <div class="card-header">
          <h3>{{capitalize key}}</h3>
          <div class="edit-controls">
            <!-- Bouton crayon -->
            <button class="edit-button">
              <i class="fas fa-pencil-alt"></i>
            </button>
            <!-- Menu déroulant pour modifier la valeur -->
            <select 
              class="value-select hidden" 
              data-path="system.tempers.{{key}}.baseValue"
            >
              <option value="malus" {{#if (eq temper.currentValue "malus")}}selected{{/if}}>Malus</option>
              <option value="neutral" {{#if (eq temper.currentValue "neutral")}}selected{{/if}}>Neutral</option>
              <option value="bonus" {{#if (eq temper.currentValue "bonus")}}selected{{/if}}>Bonus</option>
              <option value="critical" {{#if (eq temper.currentValue "critical")}}selected{{/if}}>Critical</option>
            </select>
          </div>
        </div>

        <!-- Valeur actuelle affichée -->
        <div class="card-value {{#if temper.injury}}disabled-text{{/if}}">
          {{capitalize temper.currentValue}}
        </div>

        <!-- Checkbox pour la gestion du trauma -->
        <label class="trauma-label">
          <input 
            type="checkbox" 
            id="{{key}}-trauma" 
            {{checked temper.injury}} 
          /> 
          Trauma
        </label>
      </div>
    {{/each}}
  </div>
</section>

  <!-- Dice Launcher Section -->
  <div class="dice-launcher">
    <h2>DICE LAUNCHER</h2>
    <div class="maneuver-container">
      <h3>Maneuver</h3>
    </div>
    <div class="dice-buttons">
      <button class="die-button malus" data-die-type="malus">M</button>
      <button class="die-button neutral" data-die-type="neutral">N</button>
      <button class="die-button bonus" data-die-type="bonus">B</button>
      <button class="die-button critical" data-die-type="critical">C</button>
    </div>
    <div class="selected-dice-area">
      <div class="selected-dice">
        <div class="dice-slot"></div>
        <div class="dice-slot"></div>
        <div class="dice-slot"></div>
        <div class="dice-slot"></div>
        <div class="dice-slot"></div>
        <div class="dice-slot"></div>
      </div>
      <div class="dice-controls">
        <button class="roll-selected-dice" disabled>Roll</button>
        <button class="reset-selected-dice" disabled>Reset</button>
      </div>
    </div>
  </div>
  </div>

  <!-- Section Attributes -->
<section class="attributes-section">
  <div class="attributes-header">
  <h2>Attributes</h2>
<div class="mastery-container">
  <!-- Mastery Row -->
  <div class="mastery-row">
    <!-- Mastery Level -->
    <div class="mastery-box">
  <span class="mastery-label">Mastery Level</span>
  <span id="mastery-level-view" class="mastery-value clickable">{{system.masteryLevel}}</span>
  <input type="number" id="mastery-level-edit" class="hidden" min="0" value="{{system.masteryLevel}}" />
</div>

    <!-- Mastery Points + Dice Indicators -->
    <div class="mastery-box mastery-points {{#if (ne system.masteryPoints system.masteryLevel)}}mismatched{{/if}}">
      <span class="mastery-label">Mastery Points</span>
      <span class="mastery-value">{{system.masteryPoints}}</span>

      <!-- Dice Indicators -->
      <div class="mastery-dice-indicators">
        <div class="die-indicator die-malus">
          <span>M</span>
          <span>-1</span>
        </div>
        <div class="die-indicator die-neutral">
          <span>N</span>
          <span>+0</span>
        </div>
        <div class="die-indicator die-bonus">
          <span>B</span>
          <span>+1</span>
        </div>
        <div class="die-indicator die-critical">
          <span>C</span>
          <span>+2</span>
        </div>
      </div>
    </div>
  </div>
</div>



</div>
  <!-- Grid des attributs -->
  <div class="attributes-grid">
    {{#each system.attributes as |attribute key|}}
     <div class="attribute-row">
  <!-- Carte d'attribut -->
  <div class="attribute-card" 
       data-value="{{attribute.currentValue}}"
       data-field="{{key}}"
       data-type="attributes">
    <!-- En-tête de la carte -->
    <div class="card-header">
      <h3>{{capitalize key}}</h3>
      <div class="edit-controls">
        <div class="base-value-indicator" data-value="{{attribute.baseValue}}">
          {{firstLetter attribute.baseValue}}
        </div>
        <select class="value-select hidden" data-path="system.attributes.{{key}}.baseValue">
          <option value="malus" {{#if (eq attribute.baseValue "malus")}}selected{{/if}}>Malus</option>
          <option value="neutral" {{#if (eq attribute.baseValue "neutral")}}selected{{/if}}>Neutral</option>
          <option value="bonus" {{#if (eq attribute.baseValue "bonus")}}selected{{/if}}>Bonus</option>
          <option value="critical" {{#if (eq attribute.baseValue "critical")}}selected{{/if}}>Critical</option>
        </select>
      </div>
    </div>
    <!-- Valeur actuelle -->
    <div class="card-value">
      {{capitalize attribute.currentValue}}
    </div>
    <!-- Checkbox pour les blessures -->
    <label class="injury-label">
      <input type="checkbox" 
             id="{{key}}-injury"
             class="injury-checkbox"
             {{#if attribute.injury}}checked{{/if}}
             {{#if (eq attribute.baseValue "malus")}}disabled{{/if}} />
      <span>Injured</span>
    </label>
  </div>

  <!-- Les trois lignes de tags -->
 <div class="attribute-tags">
  <div 
       class="attribute-tag-field" 
       contenteditable="true" 
       data-attribute="{{key}}" 
       data-tag="1">
    {{attribute.tag1}}
  </div>
  <div 
       class="attribute-tag-field" 
       contenteditable="true" 
       data-attribute="{{key}}" 
       data-tag="2">
    {{attribute.tag2}}
  </div>
  <div 
       class="attribute-tag-field" 
       contenteditable="true" 
       data-attribute="{{key}}" 
       data-tag="3">
    {{attribute.tag3}}
  </div>
</div>
</div>

    {{/each}}
  </div>

<!-- Global Wounds Section -->
{{#if system.wounds}}
  <div class="wounds-section">
    <h3>Wounds</h3>
    <div class="wounds-row">
  <div class="wound-box {{#if system.wounds.wound1}}ticked{{/if}} {{#if system.wounds.wound2}}locked{{/if}}" data-wound="1">
    <span class="wound-label">Wound 1</span>
    <div class="wound-mark"></div>
  </div>
  <div class="wound-box {{#if system.wounds.wound2}}ticked{{/if}} {{#unless system.wounds.wound1}}disabled{{/unless}} {{#if system.wounds.wound3}}locked{{/if}}" data-wound="2">
    <span class="wound-label">Wound 2</span>
    <div class="wound-mark"></div>
  </div>
  <div class="wound-box {{#if system.wounds.wound3}}ticked{{/if}} {{#unless system.wounds.wound2}}disabled{{/unless}}" data-wound="3">
    <span class="wound-label">Wound 3</span>
    <div class="wound-mark"></div>
  </div>
  <div class="wound-box knocked {{#if system.wounds.knockedOut}}ticked{{/if}}" data-wound="knockedOut">
    <span class="wound-label">Knocked Out</span>
    <div class="wound-mark"></div>
  </div>
</div>

  </div>
{{/if}}


</section>


</div>


</div>
</div>
 <!-- End of Profile Tab -->

<!-- Relationships Tab -->
<div class="tab" data-tab="relationships">
  <!-- Section Synergy -->
 <div class="synergy-section">
  <!-- Synergy Resources -->
  <div class="synergy-resources">

<div class="synergy-card group-synergy">
  <label>Group Synergy</label>
  <div class="resource-value">
    {{log "🔍 Rendering Group Synergy, Group Size:" groupSize}}  <!-- Debug Handlebars -->

    {{#if (lt groupSize 2)}}
      <div class="center-value">Not in a group yet</div>
    {{else if system.relationships.missingGroupTies.length}}
      <div class="missing-ties">
        <span class="warning">⚠️ Missing ties:</span>
        <ul>
          {{#each system.relationships.missingGroupTies}}
            <li>{{this}}</li>
          {{/each}}
        </ul>
      </div>
    {{else}}
      <div class="center-value">{{groupSynergy.current}}</div>
      <div class="base-value">Base: {{groupSynergy.base}}</div>
    {{/if}}
  </div>
</div>



    <div class="synergy-card maneuver-cost">
      <label>Maneuver Cost</label>
      <div class="resource-value">
        {{#if maneuverCost}}
          {{maneuverCost}}
        {{else}}
          Select members
        {{/if}}
      </div>
    </div>
  </div>

<div class="group-members-and-buttons">
  <!-- Group Members -->
  <div class="synergy-card group-members">
    <label>Group Members</label>
    <div class="resource-value">
      <ul class="members-list">
        <!-- Les membres seront insérés ici dynamiquement -->
      </ul>
      <p class="no-members" style="display: none;">No members in this group yet.</p>
    </div>
  </div>
</div>

  <!-- Group Buttons -->
 <div class="synergy-card group-buttons">
  <div class="clickable-div group-with" tabindex="0">
    Group With...
  </div>
  <div class="clickable-div return-to-my-group {{#if isInOwnGroup}}disabled{{/if}}" tabindex="0">
    Return to My Group
  </div>
</div>
</div>


  <div class="section-header">
  <button class="add-relationship custom-button">
    <i class="fas fa-plus"></i> Add Relationship
  </button>
  <div class="discord-levels">
  <div class="discord-level">
    <div class="discord-level-label">Global Discord Level</div>
    <div class="discord-level-value">{{system.relationships.allConnectionsDiscordValue}}</div>
  </div>
  <div class="discord-level">
    <div class="discord-level-label">Group Discord Level</div>
    <div class="discord-level-value">{{system.relationships.discordValueWithinGroup}}</div>
  </div>
</div>
</div>

    <!-- Grid des relations -->
    <div class="relationships-grid">
      {{#each system.relationships.connections}}
      <div class="relationship-card">
        <!-- Avatar à gauche -->
        <div class="card-avatar">
          <img src="{{img}}" alt="{{characterName}}">
        </div>

        <!-- Contenu principal -->
        <div class="relationship-card-content">
          <!-- En-tête avec nom et contrôles -->
          <div class="card-header">
            <div class="character-info">
              <h3 class="character-name">{{characterName}}</h3>
              <p class="player-name">Played by {{playerName}}</p>
            </div>
            <div class="relationship-card-controls">
              <i class="fas fa-eye card-control-icon visibility-toggle"></i>
              <i class="fas fa-trash card-control-icon delete-relationship"></i>
            </div>
          </div>
<div class="relationship-values">
  <!-- Colonne Affinity (Gauche) -->
  <div class="affinity-column">
    <h4>Affinity</h4>

    <input type="radio" id="affinity-{{@index}}-4" name="affinity-{{@index}}" value="4" data-index="{{@index}}" class="affinity-selector" {{checked (eq connection.affinity.value 4)}}>
    <label for="affinity-{{@index}}-4" class="radio-label">Enemy</label>

    <input type="radio" id="affinity-{{@index}}-3" name="affinity-{{@index}}" value="3" data-index="{{@index}}" class="affinity-selector" {{checked (eq connection.affinity.value 3)}}>
    <label for="affinity-{{@index}}-3" class="radio-label">Acquaintance</label>

    <input type="radio" id="affinity-{{@index}}-2" name="affinity-{{@index}}" value="2" data-index="{{@index}}" class="affinity-selector" {{checked (eq connection.affinity.value 2)}}>
    <label for="affinity-{{@index}}-2" class="radio-label">Friend</label>

    <input type="radio" id="affinity-{{@index}}-1" name="affinity-{{@index}}" value="1" data-index="{{@index}}" class="affinity-selector" {{checked (eq connection.affinity.value 1)}}>
    <label for="affinity-{{@index}}-1" class="radio-label">Soulmate</label>
  </div>

  <!-- Discord Value (Centre) -->
  <div class="discord-value">
    <h4>Discord Value</h4>
    <div class="value">{{multiply this}}</div>
  </div>

  <!-- Colonne Dynamic (Droite) -->
  <div class="dynamic-column">
    <h4>Dynamic</h4>

    <input type="radio" id="dynamic-{{@index}}-0.4" name="dynamic-{{@index}}" value="0.4" data-index="{{@index}}" class="dynamic-selector" {{checked (eq connection.dynamic.value 0.4)}}>
    <label for="dynamic-{{@index}}-0.4" class="radio-label">Equal</label>

    <input type="radio" id="dynamic-{{@index}}-0.5" name="dynamic-{{@index}}" value="0.5" data-index="{{@index}}" class="dynamic-selector" {{checked (eq connection.dynamic.value 0.5)}}>
    <label for="dynamic-{{@index}}-0.5" class="radio-label">Rival</label>

    <input type="radio" id="dynamic-{{@index}}-0.75" name="dynamic-{{@index}}" value="0.75" data-index="{{@index}}" class="dynamic-selector" {{checked (eq connection.dynamic.value 0.75)}}>
    <label for="dynamic-{{@index}}-0.75" class="radio-label">Inferior</label>

    <input type="radio" id="dynamic-{{@index}}-0.85" name="dynamic-{{@index}}" value="0.85" data-index="{{@index}}" class="dynamic-selector" {{checked (eq connection.dynamic.value 0.85)}}>
    <label for="dynamic-{{@index}}-0.85" class="radio-label">Superior</label>
  </div>
</div>



<!-- Nouveau conteneur pour les notes -->
<div class="relationship-notes">
  <!-- Mode affichage -->
  <div class="notes-display">
    A few words about him/her...
  </div>

  <!-- Mode édition (caché par défaut) -->
  <textarea 
    class="notes-edit hidden" 
    maxlength="200"
    placeholder="Edit your notes..."
  ></textarea>
</div>

          <!-- Support Section -->
          <div class="relationship-support">
            <div class="support-action">Support</div>
            <div class="dice-display"></div>
          </div>
        </div>
      </div>
      {{/each}}
    </div>
  </div>
</div>
  


<!-- Dans actor-character-sheet.hbs (section biographie) -->
<div class="tab" data-tab="biography">
  <h2>Biography</h2>
  
  <!-- Bouton Add Entry -->
  <button id="add-entry" class="biography-add clickable">
    <i class="fas fa-plus"></i>
    Add an Entry
  </button>

  <!-- Conteneur des entrées -->
 <div class="biography-entries">
  {{#each this.system.biography.entries as |entry index|}}
  <div class="entryContainer" data-index="{{index}}">
    <!-- Titre -->
    <div class="entryBox">
      <div class="entryTitle" contenteditable="true">{{entry.title}}</div>
    </div>

    <!-- Contenu -->
    <div class="content-wrapper">
      <!-- Zone de prévisualisation -->
      <div class="preview-pane markdown-preview {{#if entry.content}}filled{{else}}empty{{/if}}">
        {{#if entry.content}}
          {{{markdownToHtml entry.content}}}
        {{else}}
          <em>Your entry content</em>
        {{/if}}
      </div>

      <!-- Zone d'édition Markdown -->
      <div class="editor-wrapper hidden">
        <div class="markdown-toolbar">
  <button class="md-button" data-md="# " title="Heading"><i class="fas fa-heading"></i></button>
  <button class="md-button" data-md="**" title="Bold"><i class="fas fa-bold"></i></button>
  <button class="md-button" data-md="*" title="Italic"><i class="fas fa-italic"></i></button>
  <button class="md-button" data-md="- " title="List"><i class="fas fa-list"></i></button>
</div>
        <textarea class="markdown-editor">{{entry.content}}</textarea>
      </div>
    </div>

    <!-- Contrôles -->
    <div class="entryControls">
  <div class="selected-avatars">
    {{#each entry.viewers}}
      {{#with (getActor this)}}
        <img src="{{this.img}}" title="{{this.name}}" class="pj-avatar">
      {{/with}}
    {{/each}}
  </div>
  <div class="entry-buttons">
    <div class="visibility-entry clickable" data-tooltip="Manage visibility">
      <i class="fas fa-eye"></i>
    </div>
    <div class="save-entry clickable disabled" data-tooltip="Save changes">
      <i class="fas fa-save"></i>
    </div>
    <div class="delete-entry clickable" data-tooltip="Delete entry">
      <i class="fas fa-trash"></i>
    </div>
  </div>
</div>

  </div>
  {{/each}}
</div>



</div>
<!-- Template pour la modale de sélection des personnages -->
<script type="text/template" id="character-selection-template">
  <div class="character-selection-modal">
    <h2>Select Viewers</h2>
    <div class="character-list">
      {{#each characters}}
      <div class="character-option {{#if (includes ../selectedViewers this.id)}}selected{{/if}}" data-id="{{this.id}}">
        <img src="{{this.img}}" alt="{{this.name}}">
        <span>{{this.name}}</span>
      </div>
      {{/each}}
    </div>
  </div>
</script>



        <!-- Private Notes Tab -->
      <div class="tab" data-tab="private-notes">
        <h2>Private Notes</h2>
        <textarea id="private-notes" name="private-notes">{{system.privateNotes}}</textarea>
      </div>

    </div>
    
</form>