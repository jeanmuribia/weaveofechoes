<div class="initiative-tracker">
    <div class="tracker-controls">
        <button class="add-characters">
            <i class="fas fa-user-plus"></i> Add Characters
        </button>
        <button class="add-group">
            <i class="fas fa-layer-group"></i> Add Group
        </button>
        <button class="draw-initiative">
            <i class="fas fa-dice"></i> Draw Initiative!
        </button>
    </div>

    <div class="setup-section">
        <div class="section-header">
            <h2>Setup</h2>
            <button class="toggle-setup" data-section="setup">
                <i class="fas {{#if setupCollapsed}}fa-chevron-down{{else}}fa-chevron-up{{/if}}"></i>
            </button>
        </div>

        <div class="section-content {{#if setupCollapsed}}collapsed{{/if}}">
            {{#if selectedCharacters}}
            <div class="unassigned-section">
                <h3>Characters to Assign</h3>
                <div class="unassigned-characters">
                    {{#each selectedCharacters}}
                    <div class="character-token" data-character-id="{{this.id}}">
                        <img src="{{this.img}}" class="character-icon" alt="{{this.name}}" />
                        <input type="text" class="character-name-input" value="{{this.name}}" data-character-id="{{this.id}}" />
                        <div class="token-controls">
                            <button class="duplicate-char" data-character-id="{{this.id}}">
                                <i class="fas fa-clone"></i>
                            </button>
                            <button class="delete-char" data-character-id="{{this.id}}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/if}}

            <div class="initiative-groups">
                {{#each initiativeGroups}}
                <div class="group-container" data-group-id="{{this.id}}">
                    <div class="group-header">
                        <h3>{{this.name}}</h3>
                        <button class="delete-group">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="group-dropzone" data-group-id="{{this.id}}">
                        {{#if this.characters}}
                            {{#each this.characters}}
                            <div class="character-token" data-character-id="{{this.id}}">
                                <img src="{{this.img}}" class="character-icon" alt="{{this.name}}" />
                                <input type="text" class="character-name-input" value="{{this.name}}" data-character-id="{{this.id}}" />
                                <div class="token-controls">
                                    <button class="duplicate-char" data-character-id="{{this.id}}">
                                        <i class="fas fa-clone"></i>
                                    </button>
                                    <button class="delete-char" data-character-id="{{this.id}}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            {{/each}}
                        {{else}}
                            <div class="drop-hint">Drop characters here</div>
                        {{/if}}
                    </div>
                </div>
                {{/each}}
            </div>
        </div>
    </div>

{{#if isInitiativeDrawn}}
<div class="initiative-display-section">
    <div class="section-header">
        <h2>Initiative Order</h2>
        <button class="toggle-initiative" data-section="initiative">
            <i class="fas {{#if initiativeCollapsed}}fa-chevron-down{{else}}fa-chevron-up{{/if}}"></i>
        </button>
    </div>

 <div class="initiative-cards-container">
    {{#each drawnInitiative}}
    <div class="initiative-card 
        {{#if expanded}}expanded{{/if}} 
        {{#if isKO}}ko{{/if}} 
        {{#if isActive}}active-turn{{/if}}" 
        data-card-id="{{this.id}}">

        {{#if isActive}}
        <div class="active-turn-indicator">Active</div>
        {{/if}}

        <div class="card-header">
            <div class="active-toggle">
                <input type="checkbox" class="toggle-active" 
                    {{#if isActive}}checked{{/if}} 
                    {{#if isKO}}disabled{{/if}}>
            </div>
        </div>

        <div class="drag-handle">
            <div class="image-container">
                {{#if threats}}
                <div class="threat-counter">
                    {{#if (gt threats 1)}}{{threats}}{{/if}} Threat
                </div>
                {{/if}}
                <img src="{{this.img}}" class="card-image" alt="{{this.name}}" loading="lazy" />
            </div>
            
            <h3 class="card-name">{{this.name}}</h3>
        </div>

        <div class="card-controls interactive">
            <button class="expand-button" title="Expand/Collapse">
                <i class="fas fa-expand-arrows-alt"></i>
            </button>
            <button class="threat-button" title="Add Threat">
                <i class="fas fa-exclamation-triangle"></i>
            </button>
            <button class="ko-button" title="Toggle KO">
                <i class="fas fa-skull"></i>
            </button>
            <button class="delete-card" title="Remove from Initiative">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    {{/each}}
</div>

    <div class="initiative-controls">
    {{#if isInitiativeDrawn}}
    <button class="end-turn-button" {{#unless drawnInitiative.length}}disabled{{/unless}}>
        <i class="fas fa-step-forward"></i> End Turn
    </button>
    <button class="end-action-button">
        <i class="fas fa-stop"></i> End Action
    </button>
    <button class="toggle-alerts" title="Toggle turn alerts">
        <i class="fas fa-bell{{#unless alertsEnabled}}-slash{{/unless}}"></i> 
        {{#if alertsEnabled}}Disable{{else}}Enable{{/if}} Alerts
    </button>
    {{/if}}
</div>
</div>
{{/if}}

</div>
